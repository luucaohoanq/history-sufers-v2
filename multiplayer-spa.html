<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History Surfers - Multiplayer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700"
      rel="stylesheet"
    />

    <!-- Colyseus Client -->
    <script src="https://unpkg.com/colyseus.js@0.15.8/dist/colyseus.js"></script>

    <!-- Three.js -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.180.0/build/three.module.js",
          "three/examples/jsm/loaders/GLTFLoader.js": "https://unpkg.com/three@0.180.0/examples/jsm/loaders/GLTFLoader.js"
        }
      }
    </script>

    <!-- Game Scripts -->
    <script type="text/javascript" src="js/audio-manager.js"></script>
    <script type="module" src="js/network-colyseus.js"></script>
    <!-- NOT using game-multiplayer.js - logic is embedded in SPA -->
    <script type="module" src="scripts/network-strategy.js"></script>
    <script type="module" src="js/object.js"></script>
    <script type="module" src="scripts/tutorial-panel.js"></script>

    <!-- Styles -->
    <link href="style.css" rel="stylesheet" />
    <link href="./styles/lobby.style.css" rel="stylesheet" />
    <link href="./styles/sound_toggle.css" rel="stylesheet" />
    <link href="./styles/stat_panel.css" rel="stylesheet" />

    <script type="module">
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/scripts/service-worker.js', { type: 'module' })
            .catch((error) => console.error('ServiceWorker registration failed:', error));
        });
      }
    </script>
  </head>

  <body>
    <!-- ========================================
         LOBBY VIEW (Initial State)
         ======================================== -->
    <div id="lobbyView" class="view active">
      <!-- Animated Background Orbs -->
      <div class="orb orb1"></div>
      <div class="orb orb2"></div>
      <div class="orb orb3"></div>

      <!-- Food Pellets -->
      <div class="pellet" style="top: 15%; left: 10%; animation-delay: 0s"></div>
      <div class="pellet" style="top: 25%; right: 15%; animation-delay: 0.5s"></div>
      <div class="pellet" style="bottom: 20%; left: 20%; animation-delay: 1s"></div>
      <div class="pellet" style="top: 60%; right: 25%; animation-delay: 1.5s"></div>
      <div class="pellet" style="bottom: 30%; right: 10%; animation-delay: 2s"></div>
      <div class="pellet" style="top: 40%; left: 15%; animation-delay: 0.7s"></div>
      <div class="pellet" style="top: 70%; left: 40%; animation-delay: 1.2s"></div>
      <div class="pellet" style="bottom: 40%; right: 40%; animation-delay: 1.8s"></div>

      <!-- Main Container -->
      <div class="container">
        <!-- Mode Selection -->
        <div id="modeSelection">
          <div class="card">
            <h1 class="card-title">Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h1>

            <div class="mode-grid">
              <!-- Single Player Mode -->
              <button class="mode-card" onclick="location.href='singleplayer.html'">
                <div class="mode-icon">üèÉ</div>
                <h3>Ch∆°i ƒë∆°n</h3>
                <p>Ch∆°i m·ªôt m√¨nh v√† luy·ªán t·∫≠p k·ªπ nƒÉng</p>
              </button>

              <!-- Multiplayer Mode -->
              <button class="mode-card multiplayer" onclick="showMultiplayerOptions()">
                <div class="mode-icon">üë•</div>
                <h3>Nhi·ªÅu ng∆∞·ªùi ch∆°i</h3>
                <p>Thi ƒëua v·ªõi b·∫°n b√®</p>
                <div class="badge-new">Colyseus</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Multiplayer Options -->
        <div id="multiplayerOptions" style="display: none">
          <div class="card">
            <button class="btn" onclick="backToModeSelection()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">Nhi·ªÅu ng∆∞·ªùi ch∆°i</h1>

            <div class="mode-grid">
              <div class="mode-card create" onclick="showCreateRoom()">
                <div class="mode-icon">‚ûï</div>
                <h3>T·∫°o ph√≤ng</h3>
                <p>T·∫°o ph√≤ng m·ªõi v√† m·ªùi b·∫°n b√®</p>
              </div>

              <div class="mode-card join" onclick="showJoinRoom()">
                <div class="mode-icon">üö™</div>
                <h3>Tham gia</h3>
                <p>Tham gia ph√≤ng b·∫±ng m√£</p>
              </div>

              <div class="mode-card browse" onclick="showRoomList()">
                <div class="mode-icon">üîç</div>
                <h3>T√¨m ph√≤ng</h3>
                <p>Xem c√°c ph√≤ng ƒëang ch·ªù</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Create Room -->
        <div id="createRoom" class="flow-section" style="display: none">
          <div class="flow-card">
            <button class="flow-back" type="button" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z" />
              </svg>
              <span>Quay l·∫°i</span>
            </button>

            <div class="flow-header">
              <h1 class="flow-title">T·∫°o ph√≤ng m·ªõi</h1>
              <p class="flow-description">
                ƒê·∫∑t t√™n c·ªßa b·∫°n v√† t·∫°o ph√≤ng ri√™ng ƒë·ªÉ m·ªùi b·∫°n b√® ho·∫∑c c·∫£ l·ªõp c√πng tham gia cu·ªôc ƒëua.
              </p>
            </div>

            <form onsubmit="createRoom(event)" class="flow-form">
              <div class="flow-field">
                <label for="createPlayerName" class="flow-label">T√™n c·ªßa b·∫°n</label>
                <input
                  type="text"
                  id="createPlayerName"
                  class="form-input"
                  placeholder="Nh·∫≠p t√™n..."
                  required
                  maxlength="20"
                />
              </div>

              <label class="flow-toggle">
                <input type="checkbox" id="classroomModeToggle" />
                <span class="flow-toggle-indicator" aria-hidden="true"></span>
                <span class="flow-toggle-body">
                  <span class="flow-toggle-title">üéì Ch·∫ø ƒë·ªô L·ªõp h·ªçc</span>
                  <span class="flow-toggle-description">
                    Ng∆∞·ªùi t·∫°o s·∫Ω l√†m gi√°m s√°t vi√™n v√† kh√¥ng tham gia ch∆°i.
                  </span>
                </span>
              </label>

              <button type="submit" class="btn btn-primary flow-submit">
                <span>T·∫°o ph√≤ng</span>
                <span aria-hidden="true">üéÆ</span>
              </button>
            </form>

            <div id="roomInfo" class="room-info flow-room" style="display: none">
              <div class="room-columns">
                <div class="room-column room-column-main">
                  <div class="room-code-card">
                    <div class="room-code-header">
                      <span class="room-code-label">M√£ ph√≤ng</span>
                      <span class="room-code-status" id="roomStatusChip">ƒêang ch·ªù ng∆∞·ªùi ch∆°i</span>
                    </div>
                    <div class="room-code-value">
                      <span id="displayRoomId">ABC123</span>
                      <button type="button" onclick="copyRoomId()" class="copy-btn room-code-copy" aria-label="Sao ch√©p m√£ ph√≤ng">
                        üìã
                      </button>
                    </div>
                    <p class="room-code-hint">Chia s·∫ª m√£ n√†y v·ªõi b·∫°n b√® ƒë·ªÉ h·ªç tham gia ph√≤ng c·ªßa b·∫°n.</p>
                  </div>

                  <div class="ready-panel">
                    <label class="flow-toggle ready-toggle">
                      <input type="checkbox" id="hostReady" onchange="toggleReady()" />
                      <span class="flow-toggle-indicator" aria-hidden="true"></span>
                      <span class="flow-toggle-body">
                        <span class="flow-toggle-title">S·∫¥N S√ÄNG</span>
                      </span>
                    </label>

                    <div class="info-message ready-message" id="readyMessage">
                      ‚è≥ Ch·ªù t·∫•t c·∫£ ng∆∞·ªùi ch∆°i s·∫µn s√†ng...
                    </div>

                    <button id="startRaceBtn" class="btn btn-primary ready-start-btn" onclick="startRace()" style="display: none">
                      <span aria-hidden="true">üèÅ</span>
                      <span>B·∫Øt ƒë·∫ßu</span>
                    </button>
                  </div>
                </div>

                <div class="room-column room-column-players">
                  <div class="room-players-card">
                    <div class="room-section-header">
                      <span class="room-section-title">Ng∆∞·ªùi ch∆°i</span>
                      <span class="room-section-meta"><span id="playerCount">0</span> ƒëang k·∫øt n·ªëi</span>
                    </div>
                    <div id="playersList" class="player-list flow-player-list"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Join Room -->
        <div id="joinRoom" class="flow-section" style="display: none">
          <div class="flow-card">
            <button class="flow-back" type="button" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z" />
              </svg>
              <span>Quay l·∫°i</span>
            </button>

            <div class="flow-header">
              <h1 class="flow-title">Tham gia ph√≤ng</h1>
              <p class="flow-description">
                Nh·∫≠p t√™n hi·ªÉn th·ªã v√† m√£ ph√≤ng m√† b·∫°n b√® cung c·∫•p ƒë·ªÉ tham chi·∫øn ngay l·∫≠p t·ª©c.
              </p>
            </div>

            <form onsubmit="joinRoom(event)" class="flow-form">
              <div class="flow-field">
                <label for="joinPlayerName" class="flow-label">T√™n c·ªßa b·∫°n</label>
                <input
                  type="text"
                  id="joinPlayerName"
                  class="form-input"
                  placeholder="Nh·∫≠p t√™n..."
                  required
                  maxlength="20"
                />
              </div>

              <div class="flow-field">
                <label for="joinRoomId" class="flow-label">M√£ ph√≤ng</label>
                <input
                  type="text"
                  id="joinRoomId"
                  class="form-input input-uppercase"
                  placeholder="Nh·∫≠p m√£ ph√≤ng..."
                  required
                  maxlength="10"
                />
              </div>

              <button type="submit" class="btn btn-primary flow-submit">
                <span>Tham gia</span>
                <span aria-hidden="true">üöÄ</span>
              </button>
            </form>
          </div>
        </div>

        <!-- Room List -->
        <div id="roomList" style="display: none">
          <div class="card" style="max-width: 600px; margin: 0 auto">
            <button class="btn" onclick="backToMultiplayerOptions()">
              <svg width="20" height="20" fill="#121212" viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
              </svg>
              Quay l·∫°i
            </button>

            <h1 class="card-title">Ph√≤ng ƒëang ch·ªù</h1>

            <div id="roomsList" class="rooms-grid"></div>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="toast"></div>
    </div>

    <!-- ========================================
         GAME VIEW (Hidden Initially)
         ======================================== -->
    <div id="gameView" class="view">
      <!-- Sound Toggle Button -->
      <button id="sound-toggle" class="sound-toggle" title="Toggle Sound">üîä</button>

      <!-- Stats Panel (Left Side) -->
      <div class="stats-panel" id="statsPanel">
        <h3>ƒê·ªò D√ÇN CH·ª¶</h3>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>Ni·ªÅm Tin</span>
            </span>
            <span class="stat-label-right" id="trust-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="trust-container">
            <div class="stat-bar-fill stat-bar-trust" id="trust-bar" style="width: 50%"></div>
          </div>
        </div>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>C√¥ng B·∫±ng</span>
            </span>
            <span class="stat-label-right" id="justice-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="justice-container">
            <div class="stat-bar-fill stat-bar-justice" id="justice-bar" style="width: 50%"></div>
          </div>
        </div>

        <div class="stat-item">
          <div class="stat-label">
            <span class="stat-label-left">
              <span>ƒêo√†n K·∫øt</span>
            </span>
            <span class="stat-label-right" id="unity-value">50/100</span>
          </div>
          <div class="stat-bar-container" id="unity-container">
            <div class="stat-bar-fill stat-bar-unity" id="unity-bar" style="width: 50%"></div>
          </div>
        </div>
      </div>

      <!-- Score Display (Top Right) -->
      <div class="score-display">
        <p id="score">0</p>
      </div>

      <!-- Game Start Panel (Center) -->
      <div class="panel" id="gamePanel">
        <div class="game-title">
          <div class="title">T·∫°m d·ª´ng</div>
        </div>

        <div class="tutorial-tabs" id="tutorialTabs">
          <button class="tab-button active" data-target="controlsSection">ƒêi·ªÅu khi·ªÉn</button>
          <button class="tab-button" data-target="pointObjectsSection">V·∫≠t ph·∫©m c·ªông ƒëi·ªÉm</button>
          <button class="tab-button" data-target="penaltyObjectsSection">V·∫≠t ph·∫©m tr·ª´ ƒëi·ªÉm</button>
        </div>

        <div class="tutorial-section active" id="controlsSection">
          <div id="controls">
            <div class="controls-column controls-direction">
              <div class="direction-grid">
                <div class="key-card key-up">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M16 4l12 20H4z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Nh·∫£y</span>
                </div>
                <div class="key-card key-left">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M4 14l20 12V2z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Tr√°i</span>
                </div>
                <div class="key-card key-down">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M16 24L4 4h24z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Tr∆∞·ª£t (Siu)</span>
                </div>
                <div class="key-card key-right">
                  <span class="key-label">
                    <svg width="32" height="28" viewBox="0 0 32 28" class="key-icon" aria-hidden="true">
                      <path d="M28 14L8 2v24z" fill="#ffd700"></path>
                    </svg>
                  </span>
                  <span class="key-desc">Ph·∫£i</span>
                </div>
              </div>
            </div>

            <div class="controls-column controls-extra">
              <div class="extra-grid">
                <div class="key-card">
                  <span class="key-label">ESC</span>
                  <span class="key-desc">Quay v·ªÅ s·∫£nh</span>
                </div>
                <div class="extra-bottom">
                  <div class="key-card">
                    <span class="key-label">V</span>
                    <span class="key-desc">ƒê·ªïi g√≥c nh√¨n</span>
                  </div>
                  <div class="key-card">
                    <span class="key-label">P</span>
                    <span class="key-desc">Thay skin</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tutorial-section" id="pointObjectsSection">
          <div class="point-object-intro">
            Ghi nh·ªõ nh·ªØng v·∫≠t ph·∫©m t√≠ch c·ª±c d∆∞·ªõi ƒë√¢y ƒë·ªÉ ∆∞u ti√™n thu th·∫≠p khi l∆∞·ªõt. Thu th·∫≠p c√†ng
            nhi·ªÅu, b·∫°n c√†ng d·ªÖ v∆∞·ª£t ƒë·ªëi th·ªß.
          </div>
          <ul class="point-object-list" id="pointObjectList"></ul>
        </div>

        <div class="tutorial-section" id="penaltyObjectsSection">
          <div class="point-object-intro">
            Nh·ªØng v·∫≠t ph·∫©m nguy hi·ªÉm n√†y s·∫Ω tr·ª´ ƒëi·ªÉm ƒë√°ng k·ªÉ ‚Äì n√© tr√°nh ƒë·ªÉ kh√¥ng t·ª•t h·∫°ng.
          </div>
          <ul class="point-object-list" id="penaltyObjectList"></ul>
        </div>

        <table id="ranks"></table>
        <div class="animate-flicker" id="variable-content">B·∫•m ph√≠m b·∫•t k√¨ ƒë·ªÉ ti·∫øp t·ª•c...</div>
      </div>

      <!-- Multiplayer HUD (Bottom Right) -->
      <div class="multiplayer-hud" id="multiplayerHud" style="display: none">
        <h3>üèÅ Ch·∫∑ng ƒëua üèÅ</h3>
        <div id="playerScores"></div>
      </div>

      <!-- üéì Admin Dashboard (Classroom Mode) -->
      <div id="adminDashboard" class="admin-dashboard" style="display: none">
        <!-- Header -->
        <div class="admin-header">
          <div class="admin-title">
            <h1>üéìVNR202 - Group7 - Classroom Dashboard</h1>
            <p class="admin-subtitle">Monitoring <span id="adminPlayerCount">0</span> students</p>
          </div>
          <div class="admin-controls">
            <button class="admin-btn admin-btn-secondary" onclick="window.returnToLobby()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"/>
              </svg>
              Exit
            </button>
          </div>
        </div>

        <!-- Race Status -->
        <div class="admin-race-status" id="adminRaceStatus">
          <div class="status-card">
            <div class="status-icon">‚è±Ô∏è</div>
            <div class="status-info">
              <div class="status-label">Race Status</div>
              <div class="status-value" id="adminRaceState">Racing</div>
            </div>
          </div>
          <div class="status-card">
            <div class="status-icon">üèÅ</div>
            <div class="status-info">
              <div class="status-label">Finished</div>
              <div class="status-value"><span id="adminFinishedCount">0</span>/<span id="adminTotalCount">0</span></div>
            </div>
          </div>
          <div class="status-card">
            <div class="status-icon">üëë</div>
            <div class="status-info">
              <div class="status-label">Leader</div>
              <div class="status-value" id="adminLeader">-</div>
            </div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="admin-leaderboard">
          <div class="leaderboard-header">
            <h2>üìä Live Leaderboard</h2>
            <div class="leaderboard-filters">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="racing">Racing</button>
              <button class="filter-btn" data-filter="finished">Finished</button>
            </div>
          </div>
          <div class="leaderboard-table">
            <div class="leaderboard-table-header">
              <div class="col-rank">#</div>
              <div class="col-name">Student Name</div>
              <div class="col-score">Score</div>
              <div class="col-status">Status</div>
            </div>
            <div class="leaderboard-table-body" id="adminLeaderboardBody">
              <!-- Players will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Race Pause Overlay -->
      <div id="pauseOverlay" class="pause-overlay">
        <div class="pause-content">
          <h2>‚è∏Ô∏è RACE PAUSED</h2>
          <p id="pauseMessage">Waiting for player to reconnect...</p>
          <div class="loading-spinner"></div>
        </div>
      </div>

      <!-- 3D World Container -->
      <div id="world"></div>
    </div>

    <!-- Toast Notification Container (Global) -->
    <div id="toast-container" class="toast toast-top toast-end z-50"></div>

    <style>
      /* View Management */
      .view {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .view.active {
        display: block;
      }

      /* Game View Specific */
      #gameView {
        background: #000;
      }

      /* Toast Styles */
      .badge-new {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .no-rooms {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 16px;
      }

      .room-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 12px;
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .room-id {
        font-weight: 700;
        font-size: 20px;
        color: #fff;
      }

      .room-players {
        color: rgba(255, 255, 255, 0.7);
      }

      .player-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 2px solid transparent;
      }

      .player-item.ready {
        border-color: rgba(76, 175, 80, 0.5);
        background: rgba(76, 175, 80, 0.1);
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 10000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.success {
        background: rgba(76, 175, 80, 0.9);
      }

      .toast.error {
        background: rgba(244, 67, 54, 0.9);
      }

      .toast.info {
        background: rgba(33, 150, 243, 0.9);
      }

      /* Pause Overlay */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .pause-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .pause-overlay.active {
        display: flex !important;
      }

      .pause-content {
        text-align: center;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
      }

      .pause-content h2 {
        font-size: 48px;
        margin-bottom: 20px;
      }

      .pause-content p {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .loading-spinner {
        margin: 20px auto;
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* üéì Admin Dashboard Styles */
      .admin-dashboard {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        overflow-y: auto;
        z-index: 9998;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 30px 50px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .admin-title h1 {
        margin: 0;
        font-size: 36px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .admin-subtitle {
        margin: 8px 0 0 0;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.7);
      }

      .admin-controls {
        display: flex;
        gap: 15px;
      }

      .admin-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .admin-btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .admin-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .admin-race-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
        padding: 30px 50px;
      }

      .status-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .status-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        border-color: rgba(102, 126, 234, 0.5);
      }

      .status-icon {
        font-size: 48px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      }

      .status-info {
        flex: 1;
      }

      .status-label {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .status-value {
        font-size: 28px;
        font-weight: 700;
        color: #fff;
      }

      .admin-leaderboard {
        padding: 0 50px 50px 50px;
      }

      .leaderboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .leaderboard-header h2 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
      }

      .leaderboard-filters {
        display: flex;
        gap: 10px;
      }

      .filter-btn {
        padding: 8px 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: #fff;
      }

      .leaderboard-table {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .leaderboard-table-header {
        display: grid;
        grid-template-columns: 80px 1fr 150px 150px;
        gap: 20px;
        padding: 20px 30px;
        background: rgba(255, 255, 255, 0.1);
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.8);
      }

      .leaderboard-table-body {
        max-height: 500px;
        overflow-y: auto;
      }

      .leaderboard-row {
        display: grid;
        grid-template-columns: 80px 1fr 150px 150px;
        gap: 20px;
        padding: 20px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease forwards;
        opacity: 0;
      }

      @keyframes slideIn {
        to {
          opacity: 1;
        }
      }

      .leaderboard-row:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .leaderboard-row.rank-1 {
        background: linear-gradient(90deg, rgba(255, 215, 0, 0.15) 0%, transparent 100%);
        border-left: 4px solid #ffd700;
      }

      .leaderboard-row.rank-2 {
        background: linear-gradient(90deg, rgba(192, 192, 192, 0.15) 0%, transparent 100%);
        border-left: 4px solid #c0c0c0;
      }

      .leaderboard-row.rank-3 {
        background: linear-gradient(90deg, rgba(205, 127, 50, 0.15) 0%, transparent 100%);
        border-left: 4px solid #cd7f32;
      }

      .col-rank {
        display: flex;
        align-items: center;
        font-size: 24px;
        font-weight: 700;
      }

      .rank-medal {
        font-size: 32px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      .col-name {
        display: flex;
        align-items: center;
        font-size: 18px;
        font-weight: 600;
      }

      .player-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 18px;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .col-score {
        display: flex;
        align-items: center;
        font-size: 24px;
        font-weight: 700;
        color: #4ade80;
        transition: all 0.5s ease;
      }

      /* üéì Score highlight animation */
      .score-updated {
        animation: scoreFlash 0.8s ease;
      }

      @keyframes scoreFlash {
        0% {
          transform: scale(1);
          color: #4ade80;
        }
        50% {
          transform: scale(1.2);
          color: #fbbf24;
          text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }
        100% {
          transform: scale(1);
          color: #4ade80;
        }
      }

      .col-status {
        display: flex;
        align-items: center;
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-racing {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.4);
      }

      .status-finished {
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
        border: 1px solid rgba(74, 222, 128, 0.4);
      }

      .status-waiting {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.4);
      }

      /* Scrollbar styling */
      .leaderboard-table-body::-webkit-scrollbar {
        width: 8px;
      }

      .leaderboard-table-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .leaderboard-table-body::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .leaderboard-table-body::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>

    <script>
      // ==================== GLOBAL STATE ====================
      let networkManager = null;
      let currentRoomId = null;
      let currentSessionId = null;
      let gameInitialized = false;
      let raceStarting = false;
      let playerScoresTimer = null;
      let isClassroomMode = false; // üéì NEW: Track classroom mode
      let isAdmin = false; // üéì NEW: Track if current user is admin
      let waitForAssetPreload = async () => {};

      // ==================== VIEW SWITCHING ====================
      function switchView(viewId) {
        document.querySelectorAll('.view').forEach((view) => {
          view.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
        console.log(`üìÑ Switched to view: ${viewId}`);
      }

      // ==================== INITIALIZATION ====================
      window.addEventListener('load', async () => {
        console.log('üéÆ Single Page App loaded');

        // ‚ö° Kick off shared asset preloading while the player is still in the lobby
        try {
          const { initAssetPreloader, waitForAssetPreloadCompletion } = await import(
            './scripts/preload-banner.js'
          );
          initAssetPreloader();
          waitForAssetPreload = async () => {
            try {
              await waitForAssetPreloadCompletion();
            } catch (error) {
              console.warn('Asset preloading completed with warnings', error);
            }
          };
        } catch (error) {
          console.error('Failed to start asset preloading:', error);
          waitForAssetPreload = async () => {};
        }

        // üéµ Initialize audio FIRST (before anything else)
        if (typeof AudioManager !== 'undefined') {
          try {
            console.log('üéµ Initializing audio...');
            AudioManager.init();
            await AudioManager.loadAll();
            console.log('‚úÖ Audio buffers loaded successfully');
          } catch (error) {
            console.error('‚ùå Failed to load audio:', error);
            showToast('Audio loading failed', 'warning');
          }
        }

        // Import and initialize network manager
        const { ColyseusNetworkManager } = await import('./js/network-colyseus.js');
        networkManager = new ColyseusNetworkManager();
        window.networkManager = networkManager;

        // Connect to server
        try {
          await networkManager.connect();
          console.log('‚úÖ Connected to Colyseus server');
        } catch (error) {
          console.error('‚ùå Failed to connect:', error);
          showToast('Failed to connect to server', 'error');
          return;
        }

        // Listen for notifications
        networkManager.on('notification', (notification) => {
          showToast(notification.message, notification.type);
        });

        // üéµ Setup sound toggle button
        const soundToggleBtn = document.getElementById('sound-toggle');
        if (soundToggleBtn && typeof AudioManager !== 'undefined') {
          // Set initial button state
          soundToggleBtn.textContent = AudioManager.getMuteState() ? 'üîá' : 'üîä';

          soundToggleBtn.addEventListener('click', () => {
            const isMuted = AudioManager.toggleMute();
            soundToggleBtn.textContent = isMuted ? 'üîá' : 'üîä';
            console.log('üéµ Sound toggled:', isMuted ? 'muted' : 'unmuted');
          });

          console.log('‚úÖ Sound toggle button setup');
        }

        // Listen for countdown
        networkManager.on('raceCountdown', (data) => {
          console.log('‚è±Ô∏è Countdown:', data.countdown);
          showToast(`Starting in ${data.countdown}...`, 'info');
        });

        // üî• Listen for race start - SWITCH TO GAME VIEW instead of navigate
        networkManager.on('raceStart', () => {
          console.log('üèÅ Race starting, switching to game view...');

          // Reset race starting flag
          raceStarting = false;

          // Switch to game view
          switchView('gameView');

          // Initialize game after switching view
          setTimeout(() => {
            if (!gameInitialized) {
              window.initMultiplayerGame(); // Call game init function
            }
          }, 100);
        });

        // üéì Listen for race ended - handle classroom mode
        networkManager.on('raceEnded', (data) => {
          console.log('üèÅ Race ended:', data);

          // Check if replay is allowed
          if (networkManager.room && networkManager.room.state) {
            const canReplay = networkManager.room.state.canReplay;

            if (!canReplay) {
              // Classroom mode: No replay
              showToast('Race finished! Return to lobby.', 'info');

              // Show final message
              setTimeout(() => {
                const message = isAdmin
                  ? 'Race complete. Students cannot replay in Classroom mode.'
                  : 'Race complete. Press ESC to return to lobby.';
                showToast(message, 'info');
              }, 2000);
            }
          }
        });

        // Listen for players updated
        networkManager.on('playerJoined', () => {
          updatePlayersList();
          updatePlayerScores();
        });

        networkManager.on('playerLeft', () => {
          updatePlayersList();
          updatePlayerScores();
        });

        networkManager.on('opponentUpdate', () => {
          updatePlayerScores();
        });

        networkManager.on('stateChanged', () => {
          updatePlayersList();
          updatePlayerScores();
        });

        // üî• NEW: Listen for individual player state changes (ready, resourcesLoaded, etc.)
        networkManager.on('playerStateChanged', () => {
          console.log('üîÑ Player state changed, updating UI...');
          updatePlayersList();
          updatePlayerScores();
          updateAdminDashboard(); // üéì Update admin dashboard
        });
      });

      // ==================== LOBBY FUNCTIONS ====================
      function showMultiplayerOptions() {
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('multiplayerOptions').style.display = 'block';

        // üéµ Play intro music when entering multiplayer lobby
        if (typeof AudioManager !== 'undefined') {
          const activeAudio = AudioManager._active();
          // Only play if not already playing
          if (!activeAudio.intro && !activeAudio.loop && !activeAudio.gameover) {
            console.log('üéµ Starting intro music...');
            AudioManager.playIntro();
          } else {
            console.log('üéµ Audio already playing');
          }
        }
      }

      function backToModeSelection() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('modeSelection').style.display = 'block';
      }

      function showCreateRoom() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('createRoom').style.display = 'block';
      }

      function showJoinRoom() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('joinRoom').style.display = 'block';
      }

      function showRoomList() {
        document.getElementById('multiplayerOptions').style.display = 'none';
        document.getElementById('roomList').style.display = 'block';
        refreshRoomList();
      }

      function backToMultiplayerOptions() {
        document.getElementById('createRoom').style.display = 'none';
        document.getElementById('joinRoom').style.display = 'none';
        document.getElementById('roomList').style.display = 'none';
        document.getElementById('multiplayerOptions').style.display = 'block';

        // Reset room info
        document.getElementById('roomInfo').style.display = 'none';
        document.querySelector('#createRoom form').style.display = 'block';
      }

      // Create room
      async function createRoom(event) {
        event.preventDefault();

        const playerName = document.getElementById('createPlayerName').value.trim();
        if (!playerName) {
          showToast('Please enter your name', 'error');
          return;
        }

        // üéì Check if classroom mode is enabled
        isClassroomMode = document.getElementById('classroomModeToggle').checked;

        try {
          showToast(isClassroomMode ? 'Creating classroom...' : 'Creating room...', 'info');

          const { roomId, sessionId } = await networkManager.createRoom(playerName, { isClassroomMode });
          currentRoomId = roomId;
          currentSessionId = sessionId;

          // üéì If classroom mode, creator is admin (not player)
          isAdmin = isClassroomMode;

          console.log('‚úÖ Room created:', roomId, isClassroomMode ? '(Classroom Mode)' : '');

          // Show room info
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';
          resetReadyToggle();

          // üéì Update UI based on mode
          updateRoomUIForClassroom();
          updatePlayersList();
          updatePlayerScores();

          showToast(
            isClassroomMode ? 'Classroom created! You are the supervisor.' : 'Room created successfully!',
            'success'
          );
        } catch (error) {
          console.error('‚ùå Failed to create room:', error);
          showToast('Failed to create room: ' + error.message, 'error');
        }
      }

      // Join room
      async function joinRoom(event) {
        event.preventDefault();

        const playerName = document.getElementById('joinPlayerName').value.trim();
        const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();

        if (!playerName || !roomId) {
          showToast('Please fill in all fields', 'error');
          return;
        }

        try {
          showToast('Joining room...', 'info');

          const result = await networkManager.joinRoom(roomId, playerName);
          currentRoomId = result.roomId;
          currentSessionId = result.sessionId;

          console.log('‚úÖ Joined room:', roomId);

          // üéì Detect if room is classroom mode
          if (networkManager.room && networkManager.room.state) {
            isClassroomMode = networkManager.room.state.isClassroomMode || false;
            isAdmin = false; // Joiner is never admin

            if (isClassroomMode) {
              console.log('üéì Joined classroom mode room');
            }
          }

          // Show room info in create room screen
          document.getElementById('joinRoom').style.display = 'none';
          document.getElementById('createRoom').style.display = 'block';
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';
          resetReadyToggle();

          // üéì Update UI if classroom mode
          updateRoomUIForClassroom();
          updatePlayersList();
          updatePlayerScores();

          showToast(
            isClassroomMode
              ? 'Joined classroom! Wait for supervisor to start.'
              : 'Joined room successfully! Wait for host to start.',
            'success'
          );
        } catch (error) {
          console.error('‚ùå Failed to join room:', error);
          showToast('Failed to join room: ' + error.message, 'error');
        }
      }

      // Start race (host only)
      function startRace() {
        if (!networkManager || !networkManager.room) {
          showToast('Not in a room', 'error');
          return;
        }

        // Prevent multiple race start attempts
        if (raceStarting) {
          console.warn('‚ö†Ô∏è Race already starting...');
          return;
        }

        raceStarting = true;
        console.log('üèÅ Host requesting race start...');

        // Disable start button
        const startBtn = document.getElementById('startRaceBtn');
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.textContent = '‚è≥ Starting...';
        }

        try {
          // üéì Use new request method for classroom mode compatibility
          if (isClassroomMode && isAdmin) {
            networkManager.requestStartRace();
          } else {
            networkManager.room.send('startRace');
          }
        } catch (error) {
          console.error('‚ùå Failed to start race:', error);
          showToast('Failed to start race', 'error');
          raceStarting = false;
          if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = 'üèÅ B·∫Øt ƒë·∫ßu';
          }
        }
      }

      // Refresh room list
      async function refreshRoomList() {
        try {
          showToast('Loading rooms...', 'info');

          const rooms = await networkManager.listRooms();
          const roomsContainer = document.getElementById('roomsList');

          if (rooms.length === 0) {
            roomsContainer.innerHTML = '<div class="no-rooms">Kh√¥ng c√≥ ph√≤ng n√†o ƒëang ch·ªù</div>';
            return;
          }

          roomsContainer.innerHTML = rooms
            .map(
              (room) => `
          <div class="room-card">
            <div class="room-header">
              <span class="room-id">${room.roomId}</span>
              <span class="room-players">${room.clients}/${room.maxClients} üë•</span>
            </div>
            <button class="btn btn-primary" onclick="quickJoinRoom('${room.roomId}')">Tham gia</button>
          </div>
        `
            )
            .join('');

          showToast(`Found ${rooms.length} room(s)`, 'success');
        } catch (error) {
          console.error('‚ùå Failed to load rooms:', error);
          showToast('Failed to load rooms', 'error');
        }
      }

      // Quick join from room list
      async function quickJoinRoom(roomId) {
        const playerName = prompt('Nh·∫≠p t√™n c·ªßa b·∫°n:');
        if (!playerName) return;

        try {
          showToast('Joining room...', 'info');

          await networkManager.joinRoom(roomId, playerName);

          // Show room info
          document.getElementById('roomList').style.display = 'none';
          document.getElementById('createRoom').style.display = 'block';
          document.getElementById('displayRoomId').textContent = roomId;
          document.getElementById('roomInfo').style.display = 'block';
          document.querySelector('#createRoom form').style.display = 'none';
          resetReadyToggle();

          updatePlayersList();
          updatePlayerScores();

          showToast('Joined successfully!', 'success');
        } catch (error) {
          console.error('‚ùå Failed to join room:', error);
          showToast('Failed to join room: ' + error.message, 'error');
        }
      }

      // Toggle ready status
      function toggleReady() {
        // üéì Admin cannot be ready in classroom mode
        if (isClassroomMode && isAdmin) {
          showToast('Admin kh√¥ng c·∫ßn s·∫µn s√†ng', 'info');
          document.getElementById('hostReady').checked = false;
          return;
        }

        const isReady = document.getElementById('hostReady').checked;
        networkManager.setReady(isReady);
        console.log('Ready status:', isReady);

        // üéì When player is ready, mark resources as loaded
        // Resources are already loaded when page loads (JS, CSS, Colyseus client, etc.)
        // We just need to notify server for validation in classroom mode
        setTimeout(() => {
          if (networkManager && networkManager.sendResourcesLoaded) {
            networkManager.sendResourcesLoaded(isReady); // true if ready, false if not ready
            console.log(isReady ? '‚úÖ Resources marked as loaded' : '‚è≥ Resources marked as unloaded');
          }
        }, 500); // Small delay to ensure ready is processed first
      }

      function resetReadyToggle() {
        const readyInput = document.getElementById('hostReady');
        if (!readyInput) return;

        readyInput.checked = false;

        if (networkManager && typeof networkManager.setReady === 'function') {
          networkManager.setReady(false);
        }
      }

      // üéì Update UI for classroom mode
      function updateRoomUIForClassroom() {
        if (!isClassroomMode) return;

        const readySection = document.querySelector('.ready-panel');
        if (!readySection) return;

        if (isAdmin) {
          // Admin UI: Hide ready checkbox, show admin controls
          const readyToggle = readySection.querySelector('.ready-toggle');
          if (readyToggle) {
            readyToggle.style.display = 'none';
          }

          const readyMessage = document.getElementById('readyMessage');
          if (readyMessage) {
            readyMessage.innerHTML = 'üéì <strong>Ch·∫ø ƒë·ªô L·ªõp h·ªçc</strong><br>B·∫°n l√† gi√°m s√°t vi√™n. ƒê·ª£i t·∫•t c·∫£ h·ªçc sinh s·∫µn s√†ng.';
          }
        } else {
          // Regular player UI in classroom mode
          const readyMessage = document.getElementById('readyMessage');
          if (readyMessage) {
            readyMessage.innerHTML = 'üéì <strong>Ch·∫ø ƒë·ªô L·ªõp h·ªçc</strong><br>ƒê·ª£i gi√°m s√°t vi√™n b·∫Øt ƒë·∫ßu.';
          }
        }
      }

      // Update players list
      function updatePlayersList() {
        if (!networkManager || !networkManager.room) return;

        const players = networkManager.getAllPlayers();
        const playersList = document.getElementById('playersList');
        const playerCount = document.getElementById('playerCount');

        if (!playersList || !playerCount) return;

        // üéì Filter out admin in classroom mode
        const actualPlayers = isClassroomMode
          ? players.filter((p) => p.sessionId !== networkManager.room.state.hostId)
          : players;

        playerCount.textContent = actualPlayers.length;

        playersList.innerHTML = actualPlayers
          .map((player) => {
            const displayName = player.name || 'Ng∆∞·ªùi ch∆°i';
            const initial = displayName.trim().charAt(0).toUpperCase() || 'P';
            const statusClass = player.ready ? 'status-ready' : 'status-not-ready';
            const statusLabel = player.ready ? '‚úÖ S·∫µn s√†ng' : '‚è≥ ƒêang ch·ªù';
            const metaLabel = player.isSelf ? 'B·∫°n' : 'Th√†nh vi√™n';

            return `
              <div class="player-item ${player.ready ? 'is-ready' : 'is-waiting'}">
                <div class="player-info">
                  <div class="player-avatar">${initial}</div>
                  <div class="player-meta">
                    <span class="player-name">${displayName}${player.isSelf ? ' <span class="player-tag">B·∫°n</span>' : ''}</span>
                    <span class="player-note">${metaLabel}</span>
                  </div>
                </div>
                <span class="player-status ${statusClass}">${statusLabel}</span>
              </div>
            `;
          })
          .join('');

        const statusChip = document.getElementById('roomStatusChip');
        if (statusChip) {
          const readyCount = actualPlayers.filter((p) => p.ready).length;
          if (actualPlayers.length === 0) {
            statusChip.textContent = 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i';
            statusChip.classList.remove('is-ready');
          } else if (readyCount === actualPlayers.length) {
            statusChip.textContent = 'T·∫•t c·∫£ ƒë√£ s·∫µn s√†ng';
            statusChip.classList.add('is-ready');
          } else {
            statusChip.textContent = `${readyCount}/${actualPlayers.length} s·∫µn s√†ng`;
            statusChip.classList.remove('is-ready');
          }
        }

        // üéì Classroom mode: Only admin can start, all players must be ready
        if (isClassroomMode && isAdmin) {
          const allReady = actualPlayers.every((p) => p.ready);
          const startBtn = document.getElementById('startRaceBtn');

          if (startBtn) {
            const canStart = allReady && actualPlayers.length >= 1;
            startBtn.style.display = canStart ? 'inline-flex' : 'none';
            startBtn.disabled = !canStart;
            const icon = canStart ? 'üèÅ' : '‚è≥';
            const label = canStart ? 'B·∫Øt ƒë·∫ßu' : 'Ch·ªù t·∫•t c·∫£ s·∫µn s√†ng...';
            startBtn.innerHTML = `<span aria-hidden="true">${icon}</span><span>${label}</span>`;
          }
        } else if (!isClassroomMode) {
          // Normal mode: Show start button if host and all ready
          const isHost = networkManager.sessionId === networkManager.room.state.hostId;
          const allReady = actualPlayers.every((p) => p.ready);
          const startBtn = document.getElementById('startRaceBtn');

          if (startBtn) {
            const canStart = isHost && allReady && actualPlayers.length >= 2;
            startBtn.style.display = canStart ? 'inline-flex' : 'none';
            startBtn.disabled = !canStart;
            const icon = canStart ? 'üèÅ' : '‚è≥';
            const label = canStart ? 'B·∫Øt ƒë·∫ßu' : 'Ch·ªù t·∫•t c·∫£ s·∫µn s√†ng...';
            startBtn.innerHTML = `<span aria-hidden="true">${icon}</span><span>${label}</span>`;
          }
        }
      }

      // üéì Update Admin Dashboard (Classroom Mode)
      function updateAdminDashboard() {
        if (!isClassroomMode || !isAdmin || !networkManager || !networkManager.room) return;

        const dashboard = document.getElementById('adminDashboard');
        if (!dashboard) return;

        const state = networkManager.room.state;
        const players = networkManager.getAllPlayers().filter((p) => p.sessionId !== state.hostId);

        // Update player count in header
        const playerCountElem = document.getElementById('adminPlayerCount');
        if (playerCountElem) {
          playerCountElem.textContent = players.length;
        }

        // Update race status card
        const raceStatusValue = document.getElementById('raceStatusValue');
        if (raceStatusValue) {
          const statusMap = {
            waiting: 'ƒêang ch·ªù',
            countdown: 'ƒê·∫øm ng∆∞·ª£c',
            racing: 'ƒêang ƒëua',
            finished: 'ƒê√£ k·∫øt th√∫c'
          };
          raceStatusValue.textContent = statusMap[state.raceStatus] || 'N/A';
        }

        // Update finished count card
        const finishedCountValue = document.getElementById('finishedCountValue');
        if (finishedCountValue) {
          const finishedCount = players.filter((p) => p.finishTime !== null).length;
          finishedCountValue.textContent = `${finishedCount} / ${players.length}`;
        }

        // Update leader card
        const leaderValue = document.getElementById('leaderValue');
        if (leaderValue) {
          const sortedPlayers = players.slice().sort((a, b) => b.score - a.score);
          if (sortedPlayers.length > 0 && sortedPlayers[0].score > 0) {
            leaderValue.textContent = sortedPlayers[0].name;
          } else {
            leaderValue.textContent = 'N/A';
          }
        }

        // Update leaderboard table
        updateLeaderboardTable(players);
      }

      // üéì Update Leaderboard Table
      let currentFilter = 'all';
      let previousScores = {}; // Track previous scores to detect changes
      let previousPlayerList = []; // Track previous player order

      function updateLeaderboardTable(players) {
        const tableBody = document.querySelector('.leaderboard-table-body');
        if (!tableBody) return;

        // Apply filter
        let filteredPlayers = players.slice();
        if (currentFilter === 'racing') {
          filteredPlayers = players.filter((p) => p.finishTime === null);
        } else if (currentFilter === 'finished') {
          filteredPlayers = players.filter((p) => p.finishTime !== null);
        }

        // Sort by score descending
        filteredPlayers.sort((a, b) => b.score - a.score);

        // Check if player list changed (order, count, or members)
        const currentPlayerIds = filteredPlayers.map((p) => p.sessionId).join(',');
        const previousPlayerIds = previousPlayerList.map((p) => p.sessionId).join(',');
        const playersChanged = currentPlayerIds !== previousPlayerIds;

        // Only regenerate entire table if players changed
        if (playersChanged) {
          tableBody.innerHTML = filteredPlayers
            .map((player, index) => {
              const rank = index + 1;
              const rankClass = rank <= 3 ? `rank-${rank}` : '';
              const rankDisplay =
                rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;

              const status = player.finishTime !== null ? 'finished' : 'racing';
              const statusText = status === 'finished' ? 'Ho√†n th√†nh' : 'ƒêang ƒëua';
              const statusClass = `status-${status}`;

              const initial = player.name.charAt(0).toUpperCase();

              return `
            <div class="leaderboard-row ${rankClass}" data-player-id="${player.sessionId}" style="animation-delay: ${index * 0.05}s">
              <div class="col-rank">
                ${rank <= 3 ? `<span class="rank-medal">${rankDisplay}</span>` : rankDisplay}
              </div>
              <div class="col-name">
                <div class="player-avatar">${initial}</div>
                ${player.name}
              </div>
              <div class="col-score" data-score="${player.score}">${player.score}</div>
              <div class="col-status">
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
            </div>
          `;
            })
            .join('');
        } else {
          // Players didn't change, just update scores and status
          filteredPlayers.forEach((player, index) => {
            const row = tableBody.querySelector(
              `.leaderboard-row[data-player-id="${player.sessionId}"]`
            );
            if (!row) return;

            const scoreElement = row.querySelector('.col-score');
            const statusElement = row.querySelector('.status-badge');

            if (scoreElement) {
              const currentScore = parseInt(scoreElement.getAttribute('data-score')) || 0;
              const newScore = player.score;

              // Only update if score changed
              if (currentScore !== newScore) {
                scoreElement.setAttribute('data-score', newScore);
                scoreElement.textContent = newScore;

                // Add flash animation
                scoreElement.classList.remove('score-updated'); // Remove first to restart animation
                void scoreElement.offsetWidth; // Force reflow
                scoreElement.classList.add('score-updated');

                // Remove class after animation
                setTimeout(() => {
                  scoreElement.classList.remove('score-updated');
                }, 850);
              }
            }

            // Update status if changed
            if (statusElement) {
              const status = player.finishTime !== null ? 'finished' : 'racing';
              const statusText = status === 'finished' ? 'Ho√†n th√†nh' : 'ƒêang ƒëua';
              const statusClass = `status-${status}`;

              statusElement.className = `status-badge ${statusClass}`;
              statusElement.textContent = statusText;
            }
          });
        }

        // Update previous scores and player list
        const newScores = {};
        filteredPlayers.forEach((p) => {
          newScores[p.sessionId] = p.score;
        });
        previousScores = newScores;
        previousPlayerList = filteredPlayers.map((p) => ({ ...p }));
      }

      // üéì Setup Leaderboard Filters
      function setupLeaderboardFilters() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach((btn) => {
          btn.addEventListener('click', () => {
            // Update active state
            filterBtns.forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');

            // Update filter and refresh table
            currentFilter = btn.dataset.filter;
            updateAdminDashboard();
          });
        });
      }

      // üéì Setup Exit Dashboard Button
      function setupExitDashboardButton() {
        const exitBtn = document.getElementById('exitDashboardBtn');
        if (exitBtn) {
          exitBtn.addEventListener('click', () => {
            // Hide admin dashboard
            const dashboard = document.getElementById('adminDashboard');
            if (dashboard) {
              dashboard.style.display = 'none';
            }

            // Return to lobby
            if (window.returnToLobby) {
              window.returnToLobby();
            }
          });
        }
      }

      function updatePlayerScores() {
        const scoresContainer = document.getElementById('playerScores');
        if (!scoresContainer) return;

        if (!networkManager || !networkManager.room || !networkManager.room.state) {
          scoresContainer.innerHTML = '';
          return;
        }

        const players = networkManager.getAllPlayers().slice();

        if (players.length === 0) {
          scoresContainer.innerHTML = '<div class="player-score-empty">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i</div>';
          return;
        }

        players.sort((a, b) => {
          const scoreA = typeof a.score === 'number' ? a.score : 0;
          const scoreB = typeof b.score === 'number' ? b.score : 0;
          if (scoreB !== scoreA) return scoreB - scoreA;
          return (a.name || '').localeCompare(b.name || '');
        });

        const fragment = document.createDocumentFragment();

        players.forEach((player, index) => {
          const item = document.createElement('div');
          item.className = 'player-score-item';

          if (player.isSelf) {
            item.classList.add('self');
          }

          const nameEl = document.createElement('span');
          nameEl.className = 'player-score-name';

          const playerName = player.name || `Ng∆∞·ªùi ch∆°i ${index + 1}`;
          nameEl.textContent = `${index + 1}. ${playerName}${player.isSelf ? ' (B·∫°n)' : ''}`;

          const scoreEl = document.createElement('span');
          scoreEl.className = 'player-score-value';
          const scoreValue = typeof player.score === 'number' ? player.score : 0;
          scoreEl.textContent = scoreValue;

          item.appendChild(nameEl);
          item.appendChild(scoreEl);
          fragment.appendChild(item);
        });

        scoresContainer.innerHTML = '';
        scoresContainer.appendChild(fragment);

        // üéì Update admin dashboard as well (if classroom mode)
        updateAdminDashboard();
      }

      function startPlayerScoreUpdates() {
        if (playerScoresTimer) return;
        updatePlayerScores();
        // üéì Update every 2 seconds for better readability
        playerScoresTimer = setInterval(updatePlayerScores, 2000);
      }

      function stopPlayerScoreUpdates() {
        if (playerScoresTimer) {
          clearInterval(playerScoresTimer);
          playerScoresTimer = null;
        }

        const scoresContainer = document.getElementById('playerScores');
        if (scoresContainer) {
          scoresContainer.innerHTML = '';
        }
      }

      // Copy room ID to clipboard
      function copyRoomId() {
        const roomId = document.getElementById('displayRoomId').textContent;
        navigator.clipboard.writeText(roomId).then(
          () => showToast('Room ID copied!', 'success'),
          () => showToast('Failed to copy', 'error')
        );
      }

      // Toast notification
      function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;

        setTimeout(() => {
          toast.className = 'toast';
        }, 3000);
      }

      // ==================== GAME INITIALIZATION ====================
      window.initMultiplayerGame = async function () {
        console.log('üéÆ Initializing multiplayer game...');

        if (gameInitialized) {
          console.warn('‚ö†Ô∏è Game already initialized');
          return;
        }

        if (window.currentWorld) {
          console.warn('‚ö†Ô∏è World already exists');
          return;
        }

        // üéì In classroom mode, admin (spectator) doesn't initialize game
        if (isClassroomMode && isAdmin) {
          console.log('üéì Admin spectating, not initializing game');
          showToast('You are spectating this classroom session', 'info');

          // Show admin dashboard instead of HUD
          const adminDashboard = document.getElementById('adminDashboard');
          if (adminDashboard) {
            adminDashboard.style.display = 'block';
            setupLeaderboardFilters(); // Setup filter buttons
            setupExitDashboardButton(); // Setup exit button
            updateAdminDashboard(); // Initial update
          }

          // Hide multiplayer HUD
          const multiplayerHud = document.getElementById('multiplayerHud');
          if (multiplayerHud) {
            multiplayerHud.style.display = 'none';
          }

          startPlayerScoreUpdates(); // This will update dashboard periodically
          return;
        }

        try {
          await waitForAssetPreload();
          gameInitialized = true;

          // Import required modules
          const { WorldMap } = await import('./scripts/maps.js');
          const { MultiplayerStrategy } = await import('./scripts/network-strategy.js');

          // Hide game panel if exists
          const panel = document.getElementById('gamePanel');
          if (panel) panel.style.display = 'none';

          // Create multiplayer strategy
          const networkStrategy = new MultiplayerStrategy(networkManager);

          // Create world with multiplayer strategy
          const world = new WorldMap(networkStrategy);
          window.currentWorld = world;

          console.log('‚úÖ Multiplayer game started');

          // Show multiplayer HUD
          const multiplayerHud = document.getElementById('multiplayerHud');
          if (multiplayerHud) {
            multiplayerHud.style.display = 'block';
          }

          startPlayerScoreUpdates();

          // üéì Notify server that resources are loaded
          if (networkManager && networkManager.sendResourcesLoaded) {
            setTimeout(() => {
              networkManager.sendResourcesLoaded();
              console.log('‚úÖ Resources loaded notification sent');
            }, 1000);
          }

          // Handle audio transition (intro -> loop)
          if (typeof AudioManager !== 'undefined') {
            const activeAudio = AudioManager._active();
            
            // Check if audio buffers are loaded
            const buffers = AudioManager._buffers();
            if (!buffers.intro || !buffers.loop) {
              console.warn('‚ö†Ô∏è Audio buffers not loaded yet, skipping audio transition');
              return;
            }

            if (!activeAudio.loop) {
              // Intro is playing, transition to loop
              console.log('üéµ Transitioning from intro to loop...');
              AudioManager.play(); // This crossfades intro -> loop
            } else {
              console.log('üéµ Loop already playing');
            }
          }
        } catch (error) {
          console.error('‚ùå Failed to initialize game:', error);
          showToast('Failed to start game', 'error');
          gameInitialized = false;
        }
      };

      // ==================== GAME RETURN TO LOBBY ====================
      window.returnToLobby = function () {
        console.log('üîô Returning to lobby...');

        // Cleanup game
        if (window.currentWorld && typeof window.currentWorld.cleanup === 'function') {
          window.currentWorld.cleanup();
          window.currentWorld = null;
        }

        // Stop audio
        if (typeof AudioManager !== 'undefined') {
          AudioManager.stop();
        }

        // Reset game state
        gameInitialized = false;
        isClassroomMode = false; // üéì Reset classroom mode
        isAdmin = false; // üéì Reset admin flag

        stopPlayerScoreUpdates();

        // Switch back to lobby view
        switchView('lobbyView');

        // Reset lobby to multiplayer options
        backToMultiplayerOptions();
        backToModeSelection();

        // üéµ Restart intro music after returning to lobby
        if (typeof AudioManager !== 'undefined') {
          setTimeout(() => {
            const activeAudio = AudioManager._active();
            if (!activeAudio.intro && !activeAudio.loop && !activeAudio.gameover) {
              console.log('üéµ Restarting intro music in lobby...');
              AudioManager.playIntro();
            }
          }, 500);
        }
      };
    </script>
  </body>
</html>
